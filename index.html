<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Google Drive</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      text-align: center;
      padding: 20px;
    }
    video {
      width: 90%;
      max-width: 400px;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>ğŸ¥ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Google Drive</h2>
  <video id="preview" autoplay muted playsinline></video><br>
  <button id="start">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>

  <script>
    const CLIENT_ID = '31931961077-df4rgd4i3dogfu7ehkalgqf2mjkih499.apps.googleusercontent.com';
    const FOLDER_ID = '15JSLZ8Yku9ZzckuaFyhVoKshHsL6qMq_';
    let accessToken = '';
    let mediaRecorder;
    let recordedChunks = [];

    const video = document.getElementById('preview');
    const startButton = document.getElementById('start');

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
      video.srcObject = stream;
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.onstop = uploadVideo;
    }

    // Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Google OAuth
    function loginToGoogle() {
      const redirectUri = window.location.origin + window.location.pathname;
      const scope = 'https://www.googleapis.com/auth/drive.file';
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${redirectUri}&scope=${scope}`;
      window.location.href = authUrl;
    }

    // Ø§Ù„ØªÙ‚Ø§Ø· Access Token
    window.onload = () => {
      if (window.location.hash.includes('access_token')) {
        accessToken = new URLSearchParams(window.location.hash.substring(1)).get('access_token');
        startCamera();
      } else {
        loginToGoogle();
      }
    };

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    startButton.onclick = () => {
      recordedChunks = [];
      mediaRecorder.start();
      startButton.textContent = '...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
      startButton.disabled = true;

      setTimeout(() => {
        mediaRecorder.stop();
        startButton.textContent = 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœ…';
      }, 5000); // ØªØ³Ø¬ÙŠÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
    };

    // Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Google Drive
    async function uploadVideo() {
      const blob = new Blob(recordedChunks, { type: 'video/webm' });

      const metadata = {
        name: `video_${Date.now()}.webm`,
        mimeType: 'video/webm',
        parents: [FOLDER_ID]
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', blob);

      const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
        body: form
      });

      if (res.ok) {
        alert('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ Google Drive Ø¨Ù†Ø¬Ø§Ø­');
      } else {
        alert('âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
      }
    }
  </script>
</body>
</html>
